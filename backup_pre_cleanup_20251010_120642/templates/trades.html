{% extends "tabs.html" %}

{% block content %}
<h1>Latest Trade Decisions</h1>
<div style="background: #e3f2fd; padding: 10px; border-radius: 5px; margin-bottom: 20px; font-size: 14px;">
    <strong>ðŸ“Š Configuration:</strong> <span id="currentConfigHash">Loading...</span>
</div>
<table>
    <thead>
        <tr>
            <th>Ticker</th>
            <th>Action</th>
            <th>Amount (USD)</th>
            <th>Reason</th>
            <th>Timestamp</th>
        </tr>
    </thead>
    <tbody>
        {% for trade in trades %}
            {% for decision in trade.data %}
            <tr>
                <td>{{ decision.get('ticker', 'N/A') }}</td>
                <td>{{ decision.get('action', 'N/A') }}</td>
                <td>${{ '%.2f'|format(decision.get('amount_usd', 0)) if decision.get('amount_usd') else 'N/A' }}</td>
                <td>{{ decision.get('reason', 'N/A') }}</td>
                <td class="timestamp-utc" data-timestamp="{{ trade.timestamp }}">{{ trade.timestamp }}</td>
            </tr>
            {% endfor %}
        {% endfor %}
    </tbody>
</table>

<script>
// Utility function to convert UTC timestamp to PST
function formatTimestampToPST(utcTimestamp) {
    try {
        // The timestamp from database is in UTC but doesn't have timezone info
        // We need to explicitly treat it as UTC
        let date;
        
        if (utcTimestamp.includes('T')) {
            // ISO format: 2025-08-20T19:00:23.503962
            date = new Date(utcTimestamp + 'Z'); // Add Z to indicate UTC
        } else {
            // Space format: 2025-08-20 19:00:23.503962
            date = new Date(utcTimestamp.replace(' ', 'T') + 'Z'); // Convert to ISO and add Z
        }
        
        const options = {
            timeZone: 'America/Los_Angeles',
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit',
            hour12: false
        };
        const pstString = date.toLocaleString('en-US', options);
        return pstString + ' PST';
    } catch (error) {
        console.error('Timestamp conversion error:', error, 'for timestamp:', utcTimestamp);
        return utcTimestamp; // fallback to original if parsing fails
    }
}

// Convert all timestamps to PST
document.addEventListener('DOMContentLoaded', function() {
    const timestampElements = document.querySelectorAll('.timestamp-utc');
    timestampElements.forEach(element => {
        const utcTimestamp = element.getAttribute('data-timestamp');
        const pstTimestamp = formatTimestampToPST(utcTimestamp);
        element.textContent = pstTimestamp;
    });
});

// Display current configuration hash
fetch('/api/configuration')
    .then(response => response.json())
    .then(data => {
        const configElement = document.getElementById('currentConfigHash');
        const configHash = data.config_hash || 'Unknown';
        const model = data.gpt_model || 'Unknown';
        const promptMode = data.prompt_config?.mode || 'Unknown';
        const promptVersions = data.prompt_versions || {};
        
        let promptDisplay;
        if (promptMode === 'auto') {
            promptDisplay = `AUTO (v${promptVersions.summarizer_version || 0}/v${promptVersions.decider_version || 0})`;
        } else {
            promptDisplay = `FIXED v${data.prompt_config?.forced_version || 0}`;
        }
        
        configElement.innerHTML = `${configHash} (${model}, ${promptDisplay})`;
    })
    .catch(error => {
        document.getElementById('currentConfigHash').textContent = 'Error loading config';
    });
</script>
{% endblock %}

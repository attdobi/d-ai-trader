{% extends "tabs.html" %}

{% block content %}
<h1>Portfolio Dashboard</h1>
<div class="portfolio-summary">
    <div class="metric-card">
        <h3>Total Portfolio Value</h3>
        <p class="value">${{ '%.2f'|format(total_value) }}</p>
    </div>
    <div class="metric-card">
        <h3>Cash Balance</h3>
        <p class="value">${{ '%.2f'|format(cash_balance) }}</p>
    </div>
    <div class="metric-card">
        <h3>Invested Amount</h3>
        <p class="value">${{ '%.2f'|format(total_invested) }}</p>
    </div>
    <div class="metric-card {% if total_profit_loss >= 0 %}gain{% else %}loss{% endif %}">
        <h3>Total P&L</h3>
        <p class="value">${{ '%.2f'|format(total_profit_loss) }}</p>
        <p class="percentage">({{ '%.2f'|format(percentage_gain) }}%)</p>
    </div>
</div>

<style>
.portfolio-summary {
    display: flex;
    gap: 20px;
    margin-bottom: 30px;
    flex-wrap: wrap;
}
.metric-card {
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    padding: 20px;
    min-width: 180px;
    text-align: center;
}
.metric-card h3 {
    margin: 0 0 10px 0;
    color: #495057;
    font-size: 14px;
    font-weight: 600;
}
.metric-card .value {
    margin: 0;
    font-size: 24px;
    font-weight: bold;
    color: #212529;
}
.metric-card .percentage {
    margin: 5px 0 0 0;
    font-size: 14px;
    font-weight: 600;
}
.metric-card.gain .value, .metric-card.gain .percentage {
    color: #28a745;
}
.metric-card.loss .value, .metric-card.loss .percentage {
    color: #dc3545;
}
.gain { color: #28a745; }
.loss { color: #dc3545; }
</style>

<table>
    <thead>
        <tr>
            <th>Ticker</th>
            <th>Shares</th>
            <th>Purchase Price</th>
            <th>Current Price</th>
            <th>Total Value</th>
            <th>Current Value</th>
            <th>Gain/Loss</th>
            <th>Reason</th>
        </tr>
    </thead>
    <tbody>
        {% for row in holdings %}
        <tr onclick="loadChart('{{ row.ticker }}')">
            <td>{{ row.ticker }}</td>
            <td>{{ row.shares }}</td>
            <td>{{ '%.2f'|format(row.purchase_price) }}</td>
            <td>{{ '%.2f'|format(row.current_price) }}</td>
            <td>{{ '%.2f'|format(row.total_value) }}</td>
            <td>{{ '%.2f'|format(row.current_value) }}</td>
            <td class="{{ 'gain' if row.gain_loss >= 0 else 'loss' }}">{{ '%.2f'|format(row.gain_loss) }}</td>
            <td>{{ row.reason }}</td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<div class="charts-container">
    <div class="chart-section">
        <h2 id="chart-title">Account Value Over Time</h2>
        <canvas id="historyChart"></canvas>
    </div>
    <div class="chart-section">
        <h2>Portfolio Performance Over Time</h2>
        <canvas id="profitChart"></canvas>
    </div>
</div>

<style>
.charts-container {
    display: flex;
    gap: 30px;
    margin-top: 30px;
    flex-wrap: wrap;
}
.chart-section {
    flex: 1;
    min-width: 400px;
}
.chart-section canvas {
    max-height: 400px;
}
</style>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    const ctx = document.getElementById('historyChart').getContext('2d');
    const profitCtx = document.getElementById('profitChart').getContext('2d');
    let chart;
    let profitChart;

    function renderChart(data, label = 'Total Account Value') {
        const labels = data.map(row => row.current_timestamp);
        const values = data.map(row => row.total_value || row.current_value);

        if (chart) chart.destroy();

        chart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: label,
                    data: values,
                    borderColor: '#007bff',
                    fill: false,
                    tension: 0.1
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: { beginAtZero: false }
                }
            }
        });
    }

    function renderProfitChart(data) {
        const labels = data.map(row => new Date(row.timestamp).toLocaleDateString());
        const profitLoss = data.map(row => row.total_profit_loss);
        const percentageGain = data.map(row => row.percentage_gain);

        if (profitChart) profitChart.destroy();

        profitChart = new Chart(profitCtx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Profit/Loss ($)',
                    data: profitLoss,
                    borderColor: function(context) {
                        const value = context.parsed.y;
                        return value >= 0 ? '#28a745' : '#dc3545';
                    },
                    backgroundColor: function(context) {
                        const value = context.parsed.y;
                        return value >= 0 ? 'rgba(40, 167, 69, 0.1)' : 'rgba(220, 53, 69, 0.1)';
                    },
                    fill: true,
                    tension: 0.1,
                    yAxisID: 'y'
                }, {
                    label: 'Percentage Gain (%)',
                    data: percentageGain,
                    borderColor: '#17a2b8',
                    fill: false,
                    tension: 0.1,
                    yAxisID: 'y1'
                }]
            },
            options: {
                responsive: true,
                interaction: {
                    mode: 'index',
                    intersect: false,
                },
                scales: {
                    x: {
                        display: true,
                        title: {
                            display: true,
                            text: 'Date'
                        }
                    },
                    y: {
                        type: 'linear',
                        display: true,
                        position: 'left',
                        title: {
                            display: true,
                            text: 'Profit/Loss ($)'
                        }
                    },
                    y1: {
                        type: 'linear',
                        display: true,
                        position: 'right',
                        title: {
                            display: true,
                            text: 'Percentage Gain (%)'
                        },
                        grid: {
                            drawOnChartArea: false,
                        },
                    }
                }
            }
        });
    }

    function loadChart(ticker = null) {
        const url = ticker ? `/api/history?ticker=${ticker}` : '/api/history';
        document.getElementById('chart-title').innerText = ticker ? `History for ${ticker}` : 'Account Value Over Time';

        fetch(url)
            .then(resp => resp.json())
            .then(data => renderChart(data, ticker || 'Total Account Value'))
            .catch(err => console.error('Failed to load chart:', err));
    }

    function loadProfitChart() {
        fetch('/api/portfolio-history')
            .then(resp => resp.json())
            .then(data => renderProfitChart(data))
            .catch(err => console.error('Failed to load profit chart:', err));
    }

    window.onload = () => {
        loadChart();
        loadProfitChart();
    };
</script>
{% endblock %}

{% extends "tabs.html" %}

{% block content %}
<h1>Portfolio Dashboard</h1>
<p><strong>Total Portfolio Value:</strong> ${{ '%.2f'|format(total_value) }}</p>
<p><strong>Cash Balance:</strong> ${{ '%.2f'|format(cash_balance) }}</p>

<table>
    <thead>
        <tr>
            <th>Ticker</th>
            <th>Shares</th>
            <th>Purchase Price</th>
            <th>Current Price</th>
            <th>Total Value</th>
            <th>Current Value</th>
            <th>Gain/Loss</th>
            <th>Reason</th>
        </tr>
    </thead>
    <tbody>
        {% for row in holdings %}
        <tr onclick="loadChart('{{ row.ticker }}')">
            <td>{{ row.ticker }}</td>
            <td>{{ row.shares }}</td>
            <td>{{ '%.2f'|format(row.purchase_price) }}</td>
            <td>{{ '%.2f'|format(row.current_price) }}</td>
            <td>{{ '%.2f'|format(row.total_value) }}</td>
            <td>{{ '%.2f'|format(row.current_value) }}</td>
            <td class="{{ 'gain' if row.gain_loss >= 0 else 'loss' }}">{{ '%.2f'|format(row.gain_loss) }}</td>
            <td>{{ row.reason }}</td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<h2 id="chart-title">Account Value Over Time</h2>
<canvas id="historyChart"></canvas>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    const ctx = document.getElementById('historyChart').getContext('2d');
    let chart;

    function renderChart(data, label = 'Total Account Value') {
        const labels = data.map(row => row.current_timestamp);
        const values = data.map(row => row.total_value || row.current_value);

        if (chart) chart.destroy();

        chart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: label,
                    data: values,
                    borderColor: '#007bff',
                    fill: false,
                    tension: 0.1
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: { beginAtZero: false }
                }
            }
        });
    }

    function loadChart(ticker = null) {
        const url = ticker ? `/api/history?ticker=${ticker}` : '/api/history';
        document.getElementById('chart-title').innerText = ticker ? `History for ${ticker}` : 'Account Value Over Time';

        fetch(url)
            .then(resp => resp.json())
            .then(data => renderChart(data, ticker || 'Total Account Value'))
            .catch(err => console.error('Failed to load chart:', err));
    }

    window.onload = () => loadChart();
</script>
{% endblock %}

{% extends "base.html" %}

{% block content %}
{% include "partials/_config_banner.html" %}

<h1>Portfolio Dashboard</h1>

{% if schwab_summary %}
<div class="account-meta">
  <div class="account-card">
    <span class="account-label">Account Hash</span>
    <span class="account-value">{{ schwab_summary.account_hash or 'â€”' }}</span>
  </div>
  <div class="account-card">
    <span class="account-label">Account #</span>
    <span class="account-value">{{ schwab_summary.account_number or 'â€”' }}</span>
  </div>
  <div class="account-card">
    <span class="account-label">Account Type</span>
    <span class="account-value">{{ schwab_summary.account_type or 'â€”' }}</span>
  </div>
  <div class="account-card">
    <span class="account-label">Mode</span>
    <span class="account-value">{{ 'Read-Only' if schwab_summary.readonly else 'Live Trading' }}</span>
  </div>
  <div class="account-card">
    <span class="account-label">Last Update</span>
    <span class="account-value">{{ schwab_summary.last_updated or 'â€”' }}</span>
  </div>
</div>
{% endif %}

<div class="portfolio-summary">
  <div class="metric-card">
    <h3>Initial Account Value</h3>
    <p class="value">${{ '%.2f'|format(initial_account_value) }}</p>
  </div>
  <div class="metric-card">
    <h3>Current Account Value</h3>
    <p class="value">${{ '%.2f'|format(current_account_value) }}</p>
  </div>
  <div class="metric-card">
    <h3>
      {% if use_schwab_positions %}
        Funds Available
      {% else %}
        Cash Balance
      {% endif %}
    </h3>
    <p class="value">${{ '%.2f'|format(cash_balance) }}</p>
    {% if use_schwab_positions and schwab_summary %}
    <p class="subtitle">
      Settled ${{ '%.2f'|format(schwab_summary.cash_balance or 0) }}
      {% if schwab_summary.unsettled_cash is not none %}
        Â· Unsettled ${{ '%.2f'|format(schwab_summary.unsettled_cash or 0) }}
      {% endif %}
      {% if schwab_summary.order_reserve is not none %}
        Â· Order Reserve ${{ '%.2f'|format(schwab_summary.order_reserve or 0) }}
      {% endif %}
    </p>
    {% endif %}
  </div>
  {% if use_schwab_positions and schwab_summary %}
  <div class="metric-card">
    <h3>Open Orders</h3>
    <p class="value">{{ schwab_summary.open_orders_count or 0 }}</p>
  </div>
  {% endif %}
  <div class="metric-card">
    <h3>Invested Amount</h3>
    <p class="value">${{ '%.2f'|format(total_invested) }}</p>
  </div>
  <div class="metric-card {% if total_profit_loss >= 0 %}gain{% else %}loss{% endif %}">
    <h3>Total P&L</h3>
    <p class="value">${{ '%.2f'|format(total_profit_loss) }}</p>
    <p class="percentage">({{ '%.2f'|format(percentage_gain) }}%)</p>
  </div>
  <div class="metric-card {% if net_gain_loss >= 0 %}gain{% else %}loss{% endif %}">
    <h3>Net Gain/Loss</h3>
    <p class="value">${{ '%.2f'|format(net_gain_loss) }}</p>
    <p class="percentage">({{ '%.2f'|format(net_percentage_gain) }}%)</p>
    <p class="subtitle">
      {% if use_schwab_positions %}
        Account cost basis ${{ '%.2f'|format(initial_investment) }}
      {% else %}
        on ${{ '%.0f'|format(initial_investment) }} initial
      {% endif %}
    </p>
  </div>
</div>

<div class="config-section">
  <h3>ðŸ¤– Current System Configuration</h3>
  <div class="config-cards">
    <div class="config-card">
      <h4>AI Model</h4>
      <p class="config-value">{{ current_config.gpt_model }}</p>
    </div>
    <div class="config-card">
      <h4>Prompt Mode</h4>
      <p class="config-value">
        {% if current_config.prompt_config.mode == 'auto' %}
          AUTO (v{{ current_config.prompt_versions.summarizer_version }}/v{{ current_config.prompt_versions.decider_version }})
        {% else %}
          FIXED v{{ current_config.prompt_config.forced_version }}
        {% endif %}
      </p>
    </div>
    {% set is_live_mode = current_config.trading_mode in ['real_world', 'live'] %}
    <div class="config-card">
      <h4>Trading Mode</h4>
      <p class="config-value {{ 'real-mode' if is_live_mode else 'sim-mode' }}">
        {% if use_schwab_positions %}
          {% if schwab_summary and not schwab_summary.readonly %}
            LIVE TRADING ðŸ’°
          {% else %}
            LIVE (READ-ONLY) ðŸ”’
          {% endif %}
        {% else %}
          {{ 'REAL_WORLD' if is_live_mode else current_config.trading_mode.upper() }} {% if is_live_mode %}ðŸ’°{% else %}ðŸŽ®{% endif %}
        {% endif %}
      </p>
    </div>
    <div class="config-card">
      <h4>Configuration Hash</h4>
      <p class="config-value hash">{{ current_config.config_hash }}</p>
    </div>
  </div>
</div>

<div class="trigger-section">
  <h3>Manual System Triggers</h3>
  <p class="trigger-description">Use these buttons to manually trigger system components for testing:</p>
  <div class="trigger-buttons">
    <button class="trigger-btn" onclick="triggerAgent('summarizer')"><span class="btn-icon">ðŸ“°</span>Run Summarizer Agents</button>
    <button class="trigger-btn" onclick="triggerAgent('decider')"><span class="btn-icon">ðŸ¤–</span>Run Decider Agent</button>
    <button class="trigger-btn" onclick="triggerAgent('feedback')"><span class="btn-icon">ðŸ“Š</span>Run Feedback Agent</button>
    <button class="trigger-btn" id="summary-analyzer-btn" onclick="runSummaryAnalyzer()"><span class="btn-icon">ðŸ§ </span>Run Summary Analyzer &amp; Momentum</button>
    <button class="trigger-btn trigger-all" onclick="triggerAgent('all')"><span class="btn-icon">ðŸš€</span>Run All Agents</button>
  </div>
  <div id="trigger-status" class="trigger-status"></div>
  <div id="summary-analyzer-output" class="trigger-status"></div>
</div>

<table>
  <thead>
    <tr>
      <th>Ticker</th>
      <th>Shares</th>
      <th>Purchase Price</th>
      <th>Current Price</th>
      <th>Total Value</th>
      <th>Current Value</th>
      <th>Gain/Loss</th>
      <th>Reason</th>
    </tr>
  </thead>
  <tbody>
    {% for row in holdings %}
    <tr onclick="loadChart('{{ row.ticker }}')">
      <td>{{ row.ticker }}</td>
      <td>{{ row.shares }}</td>
      <td>{{ '%.2f'|format(row.purchase_price) }}</td>
      <td>{{ '%.2f'|format(row.current_price) }}</td>
      <td>{{ '%.2f'|format(row.total_value) }}</td>
      <td>{{ '%.2f'|format(row.current_value) }}</td>
      <td class="{{ 'gain' if row.gain_loss >= 0 else 'loss' }}">{{ '%.2f'|format(row.gain_loss) }}</td>
      <td>{{ row.reason }}</td>
    </tr>
    {% endfor %}
  </tbody>
</table>

<div class="charts-container">
  <div class="chart-section">
    <h2 id="chart-title">Portfolio Value Over Time</h2>
    <canvas id="historyChart"></canvas>
  </div>
  <div class="chart-section">
    <h2>Net Performance vs Initial $10,000</h2>
    <canvas id="performanceChart"></canvas>
  </div>
  <div class="chart-section">
    <h2>Portfolio Breakdown</h2>
    <canvas id="breakdownChart"></canvas>
  </div>
</div>

<div class="price-update-container">
  <button class="price-update-btn" onclick="updatePrices()"><span class="btn-icon">ðŸ“ˆ</span>Update Stock Prices</button>
  <div id="price-update-status" class="price-update-status"></div>
</div>

<div class="reset-container">
  <button class="reset-btn-small" onclick="resetPortfolio()"><span class="btn-icon">ðŸ”„</span>Reset Portfolio</button>
  <div id="reset-status" class="reset-status-small"></div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script defer src="{{ url_for('static', filename='js/dashboard.js') }}"></script>
{% endblock %}

{% extends "base.html" %}

{% block content %}
{% set prompt_bundle = prompts or {} %}
{% set summarizer = prompt_bundle.get('summarizer', {}) %}
{% set decider = prompt_bundle.get('decider', {}) %}
{% set feedback_prompt = prompt_bundle.get('feedback', {}) %}

<h1>AI Trading Feedback Dashboard</h1>
{% include "partials/_config_banner.html" %}

<div class="prompt-summary">
  <div class="prompt-chip" id="summarizerVersionCard">
    <span class="prompt-chip-icon">ðŸ“Š</span>
    <div class="prompt-chip-detail">
      <span class="prompt-chip-title">Summarizer Prompt</span>
      <span class="prompt-chip-version" id="summarizerVersion">{% if summarizer.version is not none %}v{{ summarizer.version }}{% else %}v0{% endif %}</span>
      <span class="prompt-chip-desc" id="summarizerDescriptionShort">{{ summarizer.description or 'Latest summarizer template in use.' }}</span>
    </div>
  </div>
  <div class="prompt-chip" id="deciderVersionCard">
    <span class="prompt-chip-icon">ðŸŽ¯</span>
    <div class="prompt-chip-detail">
      <span class="prompt-chip-title">Decider Prompt</span>
      <span class="prompt-chip-version" id="deciderVersion">{% if decider.version is not none %}v{{ decider.version }}{% else %}v0{% endif %}</span>
      <span class="prompt-chip-desc" id="deciderDescriptionShort">{{ decider.description or 'Latest decision-making template in use.' }}</span>
    </div>
  </div>
  <div class="prompt-chip" id="feedbackVersionCard">
    <span class="prompt-chip-icon">ðŸ§­</span>
    <div class="prompt-chip-detail">
      <span class="prompt-chip-title">Feedback Prompt</span>
      <span class="prompt-chip-version" id="feedbackVersion">{% if feedback_prompt.version is not none %}v{{ feedback_prompt.version }}{% else %}v0{% endif %}</span>
      <span class="prompt-chip-desc" id="feedbackDescriptionShort">{{ feedback_prompt.description or 'Active performance review template.' }}</span>
    </div>
  </div>
</div>

<section class="prompt-section">
  <header class="prompt-section-header">
    <h2>Prompt Blueprints</h2>
    <p class="section-intro">
      Explore the exact system and user templates driving each agent. These prompts are retrieved live from the active configuration for full transparency.
    </p>
  </header>
  <div class="prompt-grid">
    <article class="prompt-card" id="summarizerPromptCard">
      <header>
        <div class="prompt-card-title">
          <span>Summarizer Agent</span>
          <span class="prompt-version-tag" id="summarizerVersionLabel">
            {% if summarizer.version is not none %}v{{ summarizer.version }}{% else %}v0{% endif %}
          </span>
        </div>
        <p class="prompt-description" id="summarizerDescriptionFull">
          {{ summarizer.description or 'Baseline summarizer template.' }}
        </p>
      </header>
      <details open>
        <summary>System Prompt</summary>
        <pre class="prompt-block" id="summarizerSystemPrompt">{{ summarizer.rendered_system_prompt|default(summarizer.system_prompt)|default('Baseline prompt unavailable.', true)|e }}</pre>
      </details>
      <details>
        <summary>User Template</summary>
        <pre class="prompt-block" id="summarizerUserTemplate">{{ summarizer.rendered_user_prompt|default(summarizer.user_prompt)|default('Baseline prompt unavailable.', true)|e }}</pre>
      </details>
    </article>

    <article class="prompt-card" id="deciderPromptCard">
      <header>
        <div class="prompt-card-title">
          <span>Decider Agent</span>
          <span class="prompt-version-tag" id="deciderVersionLabel">
            {% if decider.version is not none %}v{{ decider.version }}{% else %}v0{% endif %}
          </span>
        </div>
        <p class="prompt-description" id="deciderDescriptionFull">
          {{ decider.description or 'Baseline decision template.' }}
        </p>
      </header>
      <details open>
        <summary>System Prompt</summary>
        <pre class="prompt-block" id="deciderSystemPrompt">{{ decider.rendered_system_prompt|default(decider.system_prompt)|default('Baseline prompt unavailable.', true)|e }}</pre>
      </details>
      <details>
        <summary>User Template</summary>
        <pre class="prompt-block" id="deciderUserTemplate">{{ decider.rendered_user_prompt|default(decider.user_prompt)|default('Baseline prompt unavailable.', true)|e }}</pre>
      </details>
    </article>

    <article class="prompt-card" id="feedbackPromptCard">
      <header>
        <div class="prompt-card-title">
          <span>Feedback Agent</span>
          <span class="prompt-version-tag" id="feedbackVersionLabel">
            {% if feedback_prompt.version is not none %}v{{ feedback_prompt.version }}{% else %}v0{% endif %}
          </span>
        </div>
        <p class="prompt-description" id="feedbackDescriptionFull">
          {{ feedback_prompt.description or 'Default system analysis prompt - comprehensive system-wide feedback' }}
        </p>
      </header>
      <details open>
        <summary>System Prompt</summary>
        <pre class="prompt-block" id="feedbackSystemPrompt">{{ feedback_prompt.rendered_system_prompt|default(feedback_prompt.system_prompt)|default('Baseline prompt unavailable.', true)|e }}</pre>
      </details>
      <details>
        <summary>User Template</summary>
        <pre class="prompt-block" id="feedbackUserTemplate">{{ feedback_prompt.rendered_user_prompt|default(feedback_prompt.user_prompt)|default('Baseline prompt unavailable.', true)|e }}</pre>
      </details>
    </article>
  </div>
</section>

<div class="portfolio-summary">
  <div class="metric-card">
    <h3>Success Rate (30d)</h3>
    <p class="value" id="successRate">--</p>
  </div>
  <div class="metric-card">
    <h3>Average Profit (30d)</h3>
    <p class="value" id="avgProfit">--</p>
  </div>
  <div class="metric-card">
    <h3>Total Trades (30d)</h3>
    <p class="value" id="tradeCount">--</p>
  </div>
  <div class="metric-card">
    <h3>Feedback Count</h3>
    <p class="value" id="feedbackCount">--</p>
  </div>
</div>

<div class="feedback-section">
  <h2>ðŸ§  Latest Feedback Analysis</h2>
  <div id="latestFeedback"><p>Loading latest feedback...</p></div>
</div>

<div class="feedback-section">
  <h2>ðŸ“‹ Feedback History (Last 10)</h2>
  <div class="feedback-history-container">
    <div id="feedbackHistory"><p>Loading feedback history...</p></div>
  </div>
</div>

<div class="feedback-section">
  <h2>ðŸ“Š Recent Trade Outcomes</h2>
  <div style="overflow-x:auto;">
    <table class="outcomes-table" id="outcomesTable">
      <thead>
        <tr>
          <th class="sortable" data-column="ticker">Ticker</th>
          <th class="sortable" data-column="sell_date">Sell Date</th>
          <th class="sortable" data-column="shares">Shares</th>
          <th class="sortable" data-column="purchase_price">Purchase Price</th>
          <th class="sortable" data-column="sell_price">Sell Price</th>
          <th class="sortable" data-column="net_gain_dollars">Net Gain ($)</th>
          <th class="sortable" data-column="gain_loss_pct">Gain/Loss %</th>
          <th class="sortable" data-column="category">Category</th>
          <th class="sortable" data-column="hold_days">Hold Days</th>
        </tr>
      </thead>
      <tbody id="outcomesBody"><tr><td colspan="9">Loading...</td></tr></tbody>
    </table>
  </div>
</div>

<div class="chart-container">
  <canvas id="performanceChart"></canvas>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script defer src="{{ url_for('static', filename='js/feedback.js') }}"></script>
{% endblock %}
